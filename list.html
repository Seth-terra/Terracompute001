<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Servers</title>
    <link rel="stylesheet" href="./static/css/libs.bundle.css" />
    <link rel="stylesheet" href="./static/css/theme.bundle.css" />
    <link rel="stylesheet" href="./static/css/custom.css" />
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js"></script>
    <script src="./static/js/vendor.bundle.js"></script>
    <script src="./static/js/theme.bundle.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body, html {
          margin: 0;
          padding: 0;
          height: 100%;
          font-family: 'Arial', sans-serif;
          background: rgb(40, 43, 85); 
          color: #fff;
        }
        .card{
            border: none;
            padding-bottom: 0; 
        }
        .vmInfo:hover{
            background-color: rgba(0, 0, 0, 0.1);
        }
        /* .card:hover {
            background-color: rgb(22, 25, 65) !important;
        } */

      </style>
</head>
<body>
    <nav class="navbar py-3 navbar-expand-lg navbar-light bg-blue fixed-top" style="background-color: rgb(40, 43, 85);">
        <div class="container">
          <!-- Brand -->
          <a class="navbar-brand" href="./home.html">
            <img src="./assets/img/brand.svg" style="width: 180px" class="navbar-brand-img" alt="...">
          </a>
      
          <!-- Toggler -->
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
      
          <!-- Collapse -->
          <div class="collapse navbar-collapse" id="navbarCollapse">
      
            <!-- Toggler -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
              aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
              <i class="fe fe-x"></i>
            </button>
      
            <!-- Navigation -->
            <ul class="navbar-nav ms-auto">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDeploy" data-bs-toggle="dropdown" href="./deploy.html"
                  aria-haspopup="true" aria-expanded="false">
                  Deploy Cloud GPU
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarList" data-bs-toggle="dropdown" href="./list.html"
                  aria-haspopup="true" aria-expanded="false">
                  Manage Machines
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="navbarAccount" href="./account.html">
                  Account
                </a>
              </li> 
            </ul>
          </div>
      
        </div>
      </nav>
      <div style="height: 80px;">
    </div>
    <h2 class="text-center">Manage Machines</h2> 

    <section class="p-5 container w-100">
        <div class="col">
            <!-- <div class="card shadow mb-6"> -->
            <div>
                <div class="card-header">
                    <div class="row">
                        <div class="col">
                            <h4 class="mb-0">
                                Servers List
                            </h4>
                        </div>
                        <div class="col-auto">
                            <h4 class="mb-0">
                                External IPv4 Address / Hostname
                            </h4>
                        </div>
                    </div>
                </div>
                <div class="card-body mt-5" style="padding: 0rem">
                    <div class="list-group list-group-flush searchableSpace" id="serverList">
                        <!-- list will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const baseUrl = 'http://127.0.0.1:5000';
        //const whitelabelToken = document.cookie.split('; ').find(row => row.startsWith('whitelabelToken='));
        const whitelabelToken = "=033ee005-4469-4f37-907c-71c50447455f"
        document.addEventListener("DOMContentLoaded", async () => {
        let loggedIn = false;
        const userInfo = { email: '', orgName: '' };
        if (whitelabelToken) {
            try {
            console.log("THIS RAN!")
            const response = await fetch(`${baseUrl}/api/v0/client/whitelabel/token_verify`, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'Authorization': whitelabelToken.split('=')[1]
                },
                //body: JSON.stringify({ whitelabelToken: whitelabelToken.split('=')[1] })
            });

            if (response.ok) {
                const tokenVerifyResponse = await response.json();
                loggedIn = true;
                userInfo.email = tokenVerifyResponse.email;
                userInfo.orgName = tokenVerifyResponse.org_name;
            }
            } catch (error) {
            window.location.href = './login.html';
            }
        }
        })

        async function retrieveServers() {
            console.log("RAN RETRIEVE SERVERS!")
            const apiRoute = `${baseUrl}/api/v0/client/list`;
            const request = await fetch(apiRoute, {
                method: "POST",
                credentials: "include",
                headers: {
                    'Authorization': whitelabelToken.split('=')[1],
                },
            });

            const response = await request.json();
            populateServers(response);
        }

        function populateServers(data) {
            console.log("RAN POPULATE SERVERS!");
            const serverList = document.getElementById('serverList');
            if (data.success && data.virtualmachines) {
                let htmlContent = '';

                Object.entries(data.virtualmachines).forEach(([machineId, vm]) => {
                    const isRunning = vm.status === 'Running' || vm.status === 'Active';
                    const isWindows = vm.operating_system.toLowerCase().includes('windows');
                    const vmIcon = isWindows ? '<i class="fab fa-windows"></i>' : '<i class="fab fa-ubuntu"></i>';
                    const vmStatusClass = isRunning ? 'success' : 'danger';
                    const vmStatusIcon = `<i class="fe fe-circle text-${vmStatusClass}"></i>`;

                    const sshPort = vm.port_forwards['22'] || 'Error retrieving SSH port';
                    const accessInstruction = isWindows ? `hostname:${sshPort}` : `ssh -p ${sshPort} user@${vm.hostname}`;

                    let gpuDisplay = '';
                    let statusDisplay = vm.status;
                    let actionButtons = '';
                    if (vm.specs.gpu.type && vm.specs.gpu.amount > 0) {
                        const gpuType = vm.specs.gpu.type.replace(/geforce/g, "GeForce ")
                            .replace(/gtx/g, "GTX ")
                            .replace(/ti/g, " Ti")
                            .replace(/ada/g, "ADA ")
                            .replace(/a/g, "A")
                            .replace(/rtx/g, "RTX ")
                            .replace(/super/g, " Super")
                            .replace(/lhr/g, " LHR")
                            .replace(/-sxm4-/g, " SXM4 ")
                            .replace(/-pcie-/g, " ")
                            .replace(/p/g, "P")
                            .replace(/tesla/g, "Tesla ")
                            .replace(/quadro/g, "Quadro ")
                            .replace(/v/g, "V")
                            .replace(/gb/g, " GB");

                        gpuDisplay = `${vm.specs.gpu.amount}x ${gpuType}, `;
                    }

                    console.log("GPU DISPLAY: " + gpuDisplay);
                    console.log("GPU type: " + vm.specs.gpu.type);
                    console.log("GPU amount: " + vm.specs.gpu.amount);
                    console.log("GPU ZEROth: " + vm.specs.gpu.amount[0]);
                    switch(vm.status.toLowerCase()) {
                        case 'running':
                            statusDisplay = 'Running';
                            actionButtons = `
                                <button type="button" class="btn btn-outline-primary" onclick="stopVM('${machineId}', false)">Stop VM & reserve GPU</button>
                                <p class="text-muted mt-1">Stop your virtual machine while keeping its GPU reserved; pay full price.</p>
                                <button type="button" class="btn btn-outline-primary" onclick="stopVM('${machineId}', true)">Stop VM & release GPU</button>
                                <p class="text-muted mt-1">Stop your virtual machine while releasing its GPU for others; only pay for storage.</p>
                            `;
                            break;
                        case 'stoppeddisassociated':
                            statusDisplay = 'Stopped with resources disassociated';
                            actionButtons = `
                                <button type="button" class="btn btn-outline-success" onclick="startVM('${machineId}')">Start VM</button>
                                <p class="text-muted mt-1">Start your virtual machine.</p>
                            `;
                            break;
                        default:
                            statusDisplay = 'Stopped';
                            actionButtons = `
                                <button type="button" class="btn btn-outline-success" onclick="startVM('${machineId}')">Start VM</button>
                                <p class="text-muted mt-1">Start your virtual machine.</p>
                            `;
                    }
                    
                    htmlContent += `
                    <div class="row align-items-center vmInfo">
                    <div class="col" data-bs-toggle="collapse" href="#collapseInfo${machineId}" role="button" aria-expanded="false" aria-controls="collapseInfo${machineId}" style="cursor: pointer;">
                        <!-- <a class="searchable list-group-item card shadow mb-6" href="/manage/${vm.uuid}" data-td-server-id="${vm.uuid}"> -->
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <small class="badge badge-sm badge-rounded-circle bg-${vmStatusClass}">
                                        ${vmStatusIcon}
                                    </small>
                                    <span style="font-size: 2em" class="text-light">
                                        ${vmIcon}
                                    </span>
                                </div>
                                <div class="col">
                                    <p class="mb-0 text-light">
                                        ${vm.name}
                                        ${vm.type === 'spot' ? `<span class="badge bg-secondary-soft">Interruptible Instance — ${vm.name}</span>` : ''}
                                    </p>
                                    <small class="text-gray-500">
                                        ${vm.city}, ${vm.state}, ${vm.country}: ${gpuDisplay}
                                        ${vm.specs.vcpus} vCPUs,
                                        ${vm.specs.ram} GB RAM,
                                        ${vm.specs.storage} GB Storage,
                                        $${vm.total_price}/hour
                                    </small>
                                </div>
                                <div class="col-auto">
                                    <p class="mb-0 text-light">
                                        ${vm.ip_address || ''}
                                        ${vm.coreweave_ip_address || ''}
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>
                    </div>
                    <div class="collapse" id="collapseInfo${machineId}">
                                    <div class="card card-body">
                                        <p><strong>Hostname:</strong> ${vm.hostname}</p>
                                        <p><strong>Status:</strong> ${statusDisplay}</p>
                                        <p><strong>Specifications:</strong></p>
                                        <ul>
                                            <li><strong>GPU:</strong> ${vm.specs.gpu.type} (${vm.specs.gpu.amount})</li>
                                            <li><strong>RAM:</strong> ${vm.specs.ram} GB</li>
                                            <li><strong>Storage:</strong> ${vm.specs.storage} GB</li>
                                            <li><strong>vCPUs:</strong> ${vm.specs.vcpus}</li>
                                        </ul>
                                        <p><strong>Storage Price:</strong> $${vm.storage_price}</p>
                                        <p><strong>Compute Price:</strong> $${vm.compute_price}</p>
                                        <p><strong>Total Price:</strong> $${vm.total_price}</p>
                                        <p><strong>Port Forwards:</strong></p>
                                        <ul>
                                            ${Object.entries(vm.port_forwards).map(([key, value]) => `<li>${key} to ${value}</li>`).join('')}
                                        </ul>
                                        <p><strong>Created On:</strong> ${vm.timestamp_creation}</p>
                                        <div class="btn-group-vertical w-100" role="group" aria-label="VM Controls">
                                            ${actionButtons}
                                            <button type="button" class="btn btn-outline-danger" onclick="deleteVM('${machineId}')">Delete Virtual Machine</button>
                                            <p class="text-muted mt-1">Be careful. Once you press "delete," the VM will be instantly destroyed. All data will be lost.</p>
                                        </div>
                                        <p>Use the following commands to access your VM:</p>
                                        <pre><code>ssh -p ${sshPort} user@${vm.hostname}</code></pre>
                                        <p>If you are using key-based authentication, make sure to specify your keyfile with <code>-i &lt;identity_file&gt;</code></p>

                                        <p>Use the following IPv4 to access your VM with RDP:</p>
                                        <pre><code>${accessInstruction}</code></pre>
                                        ${!isWindows ? `
                                        <p>If you are using key-based authentication, make sure to specify your keyfile with <code>-i &lt;identity_file&gt;</code></p>
                                        ` : ''}
                                    </div>
                                </div>
                    `;
                });

                serverList.innerHTML = htmlContent;
                console.log("HTML CONTENT: ", htmlContent)
            } else {
                serverList.innerHTML = '<p>No virtual machines found.</p>';
            }
        }



        const stopVM = async (machineId, releaseGPU) => {
            console.log('Stopping VM:', machineId, 'Release GPU:', releaseGPU);
            const apiRoute = `${baseUrl}/api/v0/client/stop/single`;
            const formData = new FormData();
            formData.append("server", machineId);
            formData.append("disassociate_resources", releaseGPU);
            const response = await fetch(apiRoute, {
                method: "POST",
                body: formData,
                credentials: "include",
                headers: {
                    'Authorization': whitelabelToken.split('=')[1],
                },
            });
            console.log("RESPONSE: ", await response.json());
            if (response.ok){
                console.log("Success!");
                window.location.reload()
            }else{
                console.log("response success: ", response.success);
                console.log("ERROR!");
            }
        }

        const startVM = async (machineId) => {
            console.log('Starting VM:', machineId);
            const apiRoute = `${baseUrl}/api/v0/client/start/single`;
            const formData = new FormData();
            formData.append("server", machineId);
            const response = await fetch(apiRoute, {
                method: "POST",
                body: formData,
                credentials: "include",
                headers: {
                    'Authorization': whitelabelToken.split('=')[1],
                },
            });
            console.log("RESPONSE: ", await response.json());
            if (response.ok){
                console.log("Success!");
                window.location.reload()
            }else{
                console.log("response success: ", response.success);
                console.log("ERROR!");
            }
        }

        const deleteVM = async (machineId) => {
            console.log('Deleting VM:', machineId);
            const apiRoute = `${baseUrl}/api/v0/client/delete/single`;
            const formData = new FormData();
            formData.append("server", machineId);
            const response = await fetch(apiRoute, {
                method: "POST",
                body: formData,
                credentials: "include",
                headers: {
                    'Authorization': whitelabelToken.split('=')[1],
                },
            });x
            console.log("RESPONSE: ", await response.json());
            if (response.ok){
                console.log("Success!");
                window.location.reload()
            }else{
                console.log("response success: ", response.success);
                console.log("ERROR!");
            }
            
        }





        retrieveServers();
    </script>
</body>
</html>
